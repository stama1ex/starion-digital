datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Partner {
  id        Int      @id @default(autoincrement())
  name      String
  login     String   @unique
  password  String
  role      PartnerRole @default(PARTNER)
  createdAt DateTime @default(now())

  prices       Price[]
  orders       Order[]
  realizations Realization[]
}

model Product {
  id        Int      @id @default(autoincrement())
  type      ProductType
  number    String   @unique
  country   String
  image     String
  materialId Int     // Связь с MaterialCatalog
  costPrice Decimal  @db.Decimal(10,2) @default(0) // Себестоимость

  material  MaterialCatalog @relation(fields: [materialId], references: [id])
  items     OrderItem[]
  realizationItems RealizationItem[]
}

// Каталог материалов - для легкого добавления новых материалов
model MaterialCatalog {
  id        Int      @id @default(autoincrement())
  name      String   @unique // MARBLE, WOOD, ACRYLIC, METAL и тд
  label     String   // Мрамор, Дерево, Акрил, Металл
  createdAt DateTime @default(now())

  products Product[]
  prices   Price[]
}

model Price {
  id        Int      @id @default(autoincrement())
  partnerId Int
  type      ProductType
  materialId Int     // Связь с MaterialCatalog
  price     Decimal  @db.Decimal(10,2)

  partner   Partner          @relation(fields: [partnerId], references: [id])
  material  MaterialCatalog  @relation(fields: [materialId], references: [id])

  @@unique([partnerId, type, materialId]) // У одного партнёра только одна цена на каждую комбинацию
}

model Order {
  id            Int        @id @default(autoincrement())
  partnerId     Int
  totalPrice    Decimal    @db.Decimal(12,2)
  status        OrderStatus @default(NEW)
  isRealization Boolean    @default(false) // Флаг заказа на реализацию
  createdAt     DateTime   @default(now())

  partner    Partner     @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  items      OrderItem[]
  realization Realization?

  @@index([partnerId])
  @@index([status])
  @@index([createdAt])
  @@index([partnerId, status])
}

model OrderItem {
  id           Int      @id @default(autoincrement())
  orderId      Int
  productId    Int
  quantity     Int
  pricePerItem Decimal  @db.Decimal(10,2)
  sum          Decimal  @db.Decimal(12,2)

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
}

// Реализация товаров - товары отгруженные с условием «Реализация»
model Realization {
  id           Int      @id @default(autoincrement())
  orderId      Int      @unique
  partnerId    Int
  totalCost    Decimal  @db.Decimal(12,2) // Общая стоимость товаров
  paidAmount   Decimal  @db.Decimal(12,2) @default(0) // Сколько дилер уже заплатил
  status       RealizationStatus @default(PENDING) // PENDING, PARTIAL, COMPLETED, CANCELLED
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  order    Order              @relation(fields: [orderId], references: [id], onDelete: Cascade)
  partner  Partner            @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  items    RealizationItem[]
  payments RealizationPayment[]

  @@index([partnerId])
  @@index([status])
  @@index([createdAt])
}

// Товары в реализации
model RealizationItem {
  id              Int      @id @default(autoincrement())
  realizationId   Int
  productId       Int
  quantity        Int
  unitPrice       Decimal  @db.Decimal(10,2) // Цена продажи за единицу
  costPrice       Decimal  @db.Decimal(10,2) // Себестоимость
  totalPrice      Decimal  @db.Decimal(12,2) // quantity * unitPrice
  soldQuantity    Int      @default(0) // Сколько уже продано
  paidQuantity    Int      @default(0) // За сколько уже поступила оплата

  realization Realization @relation(fields: [realizationId], references: [id], onDelete: Cascade)
  product     Product     @relation(fields: [productId], references: [id])
}

// Платежи по реализации
model RealizationPayment {
  id            Int      @id @default(autoincrement())
  realizationId Int
  amount        Decimal  @db.Decimal(12,2)
  description   String   @default("") // Описание платежа
  createdAt     DateTime @default(now())

  realization Realization @relation(fields: [realizationId], references: [id], onDelete: Cascade)
}
enum PartnerRole {
  ADMIN
  PARTNER
}

enum ProductType {
  MAGNET
  PLATE
  POSTCARD
  STATUE
  BALL
}

enum OrderStatus {
  NEW        // Новый заказ, ожидает подтверждения
  CONFIRMED  // Подтверждён админом
  PAID       // Оплачен (учитывается в доходе)
  CANCELLED  // Отменён
}

enum RealizationStatus {
  PENDING    // Ожидает платежа
  PARTIAL    // Частичный платёж получен
  COMPLETED  // Полностью оплачена
  CANCELLED  // Отменена
}
