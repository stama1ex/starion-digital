# Миграция изображений Dropbox

## Проблема

Временные ссылки Dropbox (temporary links) имеют срок действия 4 часа. Если в базе данных сохранены временные URL изображений, они перестают работать после истечения срока действия.

## Решение

Изменена архитектура работы с изображениями:

- В базе данных теперь сохраняется **путь** к файлу в Dropbox (например, `/products/1234567890_image.avif`)
- Временные ссылки генерируются динамически при загрузке страницы через новый API эндпоинт

## Внесенные изменения

### 1. API для загрузки изображений

**Файл:** `app/api/admin/upload/route.ts`

- Изменено: возвращает `path` вместо `url`

### 2. Новый API эндпоинт для получения временных ссылок

**Файл:** `app/api/dropbox/temp-link/route.ts`

- Принимает путь к файлу в Dropbox
- Возвращает временную ссылку для загрузки

### 3. Хук для работы с изображениями Dropbox

**Файл:** `lib/hooks/useDropboxImage.ts`

- Автоматически определяет тип пути (Dropbox, HTTP URL, локальный файл)
- Загружает временные ссылки для путей Dropbox
- Поддерживает состояния загрузки и ошибок

### 4. Обновленные компоненты

- `components/shared/product-card.tsx` - использует `useDropboxImage`
- `app/my-orders/orders-content.tsx` - использует `useDropboxImage`
- `app/admin/sections/products-management.tsx` - использует `useDropboxImage` для превью

## Миграция существующих данных

Если в базе данных есть товары со старыми временными URL (начинаются с `https://`), нужно:

### Опция 1: Перезагрузить изображения

1. Зайти в админ-панель
2. Для каждого товара с неработающим изображением:
   - Открыть редактирование
   - Загрузить изображение заново
   - Сохранить

### Опция 2: SQL миграция (если есть доступ к БД)

```sql
-- Если изображения уже загружены в Dropbox и известны пути
UPDATE "Product"
SET image = '/products/' || regexp_replace(image, '^.*/([^/]+)$', '\\1')
WHERE image LIKE 'https://dl.dropboxusercontent.com%';

-- Или очистить старые URL, чтобы загрузить заново
UPDATE "Product"
SET image = ''
WHERE image LIKE 'https://%' AND image LIKE '%dropbox%';
```

### Опция 3: Скрипт миграции

Создать скрипт для автоматической миграции:

```typescript
import { prisma } from '@/lib/db';

async function migrateImages() {
  const products = await prisma.product.findMany({
    where: {
      image: {
        startsWith: 'https://',
      },
    },
  });

  console.log(`Found ${products.length} products with HTTP URLs`);

  // Здесь можно добавить логику для извлечения имени файла
  // или повторной загрузки изображений
}
```

## Тестирование

1. Загрузить новое изображение через админ-панель
2. Проверить, что в БД сохранился путь вида `/products/...`
3. Открыть страницу каталога - изображение должно загрузиться
4. Перезагрузить страницу через несколько секунд - изображение должно загрузиться снова

## Совместимость

Хук `useDropboxImage` поддерживает:

- ✅ Новые пути Dropbox: `/products/123_image.avif`
- ✅ Старые HTTP URL: `https://...` (для обратной совместимости)
- ✅ Локальные пути: `public/magnets/M01.avif`

## Преимущества нового подхода

1. **Надежность**: изображения не исчезают через 4 часа
2. **Производительность**: временные ссылки кэшируются браузером
3. **Гибкость**: поддержка разных источников изображений
4. **Простота**: автоматическое определение типа пути

## Технические детали

### Обработка изображений из Dropbox

Изображения из Dropbox загружаются через обычный `<img>` тег вместо Next.js `<Image>` компонента, потому что:

- Временные ссылки Dropbox содержат сложные параметры запроса
- Next.js Image Optimizer не может корректно обработать такие URL (ошибка 400)
- Прямая загрузка через `<img>` работает надежнее для внешних временных ссылок

Компоненты автоматически определяют, является ли URL ссылкой Dropbox (по наличию `dropboxusercontent.com`) и используют соответствующий метод отображения.
